name: Deploy Alexander

on:
  pull_request:
    types: [closed]

jobs:
  build:
    runs-on: ubuntu-20.04

    if: github.event.pull_request.merged == true && github.event.pull_request.merged_by != null

    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

    steps:
      - name: Checkout Files
        uses: actions/checkout@v4

      - name: Notify Slack
        uses: act10ns/slack@v2
        with:
          channel: "#deploy-web"
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          message: |
            ðŸ‘ Merge BackEnd de PR aprobado en ${{ github.repository }} (${{ github.event.pull_request.base.ref }}) por ${{ github.event.pull_request.merged_by.login }}.

            Detalles: ${{ github.event.pull_request.html_url }}
          mentions: "#deploy-web"
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Build Docker image
        run: |
          echo "${{ secrets.DOCKERFILE }}" > Dockerfile
          docker build -t ${{ secrets.APPBACK }}:1.0 .

      - name: Save Docker image as tar file
        run: docker save -o ${{ secrets.APPBACK }}.tar ${{ secrets.APPBACK }}:1.0

      - name: DELETE FILES
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.REMOTE_SERVER_ADDRESS }}
          username: ${{ secrets.REMOTE_SERVER_USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          script: |
            cd ~/${{secrets.REMOTE_SERVER_PATH}}
            if [ -f "${{ secrets.APPBACK }}.tar" ]; then
              rm -f ${{ secrets.APPBACK }}.tar
            else
            echo "File ${{ secrets.APPBACK }}.tar does not exist."
            fi
            if [ -f ".env" ]; then
              rm -f .env
            else
            echo "File .env does not exist."
            fi
            if [ -f "docker-compose.yml" ]; then
              rm -f docker-compose.yml
            else
              echo "File docker-compose.yml does not exist."
            fi
            if [ "$(docker ps -a -q -f name=${{ secrets.NAME_CONTAINER }})" ]; then 
              docker rm -f ${{ secrets.NAME_CONTAINER }}
            else
              echo "Container ${{ secrets.NAME_CONTAINER }} does not exist."
            fi
            if [ "$(docker images -q ${{ secrets.APPBACK }}:1.0)" ]; then
              docker rmi -f ${{ secrets.APPBACK }}:1.0
            else
              echo "Image ${{ secrets.APPBACK }}:1.0 does not exist."
            fi

      - name: Create docker-compose file
        run: |
          echo "${{ secrets.ENV_GLOBAL }}" > .env
          echo "DOCKER_IMAGE_NAME=${{ secrets.APPBACK }}" >> .env
          echo "NAME_CONTAINER=${{ secrets.NAME_CONTAINER }}" >> .env
          echo "${{ secrets.DOCKER_COMPOSE }}" > docker-compose.yml

      - name: Transfer Docker image to remote server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          scp -o StrictHostKeyChecking=no ${{ secrets.APPBACK }}.tar ${{ secrets.REMOTE_SERVER_USERNAME }}@${{ secrets.REMOTE_SERVER_ADDRESS }}:${{ secrets.REMOTE_SERVER_PATH }}
          scp -o StrictHostKeyChecking=no .env ${{ secrets.REMOTE_SERVER_USERNAME }}@${{ secrets.REMOTE_SERVER_ADDRESS }}:${{ secrets.REMOTE_SERVER_PATH }}
          scp -o StrictHostKeyChecking=no docker-compose.yml ${{ secrets.REMOTE_SERVER_USERNAME }}@${{ secrets.REMOTE_SERVER_ADDRESS }}:${{ secrets.REMOTE_SERVER_PATH }}
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_SERVER_USERNAME }}@${{ secrets.REMOTE_SERVER_ADDRESS }} << 'ENDSSH'
          docker load -i ${{ secrets.REMOTE_SERVER_PATH }}/${{ secrets.APPBACK }}.tar
          ENDSSH
          ssh -o StrictHostKeyChecking=no ${{ secrets.REMOTE_SERVER_USERNAME }}@${{ secrets.REMOTE_SERVER_ADDRESS }} << 'ENDSSH'
          docker compose -f ${{ secrets.REMOTE_SERVER_PATH }}/docker-compose.yml up -d
          ENDSSH

      - name: Notifica cuando se haya lenatado la Web
        uses: act10ns/slack@v2
        if: always()
        with:
          channel: "#deploy-web"
          status: ${{ job.status }}
          steps: ${{ toJson(steps) }}
          message: |
            ðŸ‘ Pipeline BackEnd de GitHub Actions completado en ${{ github.repository }} por ${{ github.actor }}.
            ðŸš€ EjecuciÃ³n exitosa de la integraciÃ³n continua.
